import { Button, ComboBox, SpinBox, CheckBox, VerticalBox, HorizontalBox, GroupBox, GridBox, LineEdit, TabWidget, ScrollView } from "std-widgets.slint";
export enum SimModel {
    GBM,
    Bootstrap,
}

export struct SimParams {
    initial_price: float,
    horizon: int,
    num_paths: int,
    mu: float,
    sigma: float,
    seed: int,
    use_antithetic: bool,
    dt: int,
    model_type: string,
    // Mean Reversion
    theta: float,
    mu_long_term: float,
    // Jump Diffusion
    lambda: float,
    mu_j: float,
    sigma_j: float,
    // GARCH
    omega: float,
    alpha: float,
    beta: float,
}

export struct SimStats {
    mean: float,
    std_dev: float,
    median: float,
    p5: float,
    p25: float,
    p75: float,
    p95: float,
    var95: float,
}

export component AppWindow inherits Window {
    title: "Stock Monte Carlo Simulator";
    preferred-width: 1050px;
    preferred-height: 700px;
    min-width: 960px;
    min-height: 600px;
    in-out property <[string]> ticker_list: [];
    in-out property <string> selected_ticker : "";
    in-out property <string> date_range: "Date range: N/A";
    in-out property <string> record_count: "Record count: 0";

    in-out property <float>  initial_price: 150.0;
    in-out property <int> horizon: 30;
    in-out property <int> num_paths: 1000;
    in-out property <float> mu: 0.0002;
    in-out property <float> sigma: 0.015;
    in-out property <int> seed: 12345;
    in-out property <bool> use_antithetic: true;
    in-out property <string> model_type: "GBM";

    // Mean Reversion parameters
    in-out property <float> theta: 0.1;
    in-out property <float> mu_long_term: 100.0;

    // Jump Diffusion parameters
    in-out property <float> lambda: 2.0;
    in-out property <float> mu_j: -0.02;
    in-out property <float> sigma_j: 0.05;

    // GARCH parameters
    in-out property <float> omega: 0.00001;
    in-out property <float> alpha: 0.1;
    in-out property <float> beta: 0.85;

    in property <SimStats> stats;
    in-out property <image> price_chart;
    in-out property <image> hist_chart;
    in-out property <string> exec_time: "0.0 ms";

    callback load_csv_pressed();
    callback select_ticker_changed();
    callback estimate_params_pressed();
    callback run_simulation_pressed(SimParams);
    callback export_summary_pressed();
    callback export_charts_pressed();
    callback save_setup_pressed();
    callback load_setup_pressed(); 

    HorizontalBox {
        padding: 10px;
        spacing: 10px;
        VerticalBox { // Left Panel
            preferred-width: 300px;
            min-width: 280px;
            vertical-stretch: 1; 
            GroupBox {
                title: "Control Panel";
                vertical-stretch: 1; 
                  
                VerticalBox {
                    spacing: 8px;
                    Text { text: "1. Data Input"; }
                    Button {
                        text: "Load CSV";
                        clicked => { load_csv_pressed(); } 
                    }
                    ComboBox { 
                        model: root.ticker_list;
                        selected(current-value) => {root.selected_ticker = current-value; select_ticker_changed();}
                    }
                    Text { text: root.date_range;}
                    Text { text: root.record_count;}

                    Text { text: "2. Parameter Estimation";}
                    Button {
                        text: "Estimate Î¼/Ïƒ from Data";
                        enabled: root.selected_ticker != "";
                        clicked => { estimate_params_pressed(); }
                    }
                    Text { text: "3. Save/Load Setup";}
                    HorizontalBox {
                        spacing: 5px;
                    Button {
                        text: "ðŸ’¾ Save Setup";
                        clicked => { save_setup_pressed(); }
                     }
                    Button {
                        text: "ðŸ“‚ Load Setup";
                        clicked => { load_setup_pressed(); }
                     }
                    }
                    Text { text: "4. Simulation Parameters";}
                    GridBox {
                        Row { 
                            Text { text: "Model:";} 
                            ComboBox {
                                model: ["GBM", "Bootstrap", "MeanReversion", "JumpDiffusion", "GARCH"];
                                selected => { root.model_type = self.current-value; }
                            } 
                        }
                        Row { 
                            Text { text: "Initial Price:";}
                            LineEdit { 
                                text: root.initial_price;
                                edited(text) => {root.initial_price = text.to-float();} 
                            } 
                        }
                        Row {                
                            Text { text: "Horizon (days):";}
                            SpinBox {
                                value <=> root.horizon;}
                        }
                        Row { 
                            Text { text: "Num Paths:";}
                            SpinBox {
                                value <=> root.num_paths;
                                maximum: 100000;
                                step-size: 100;
                            }
                        }
                        Row {                 
                            Text { text: "Random Seed:";}
                            SpinBox {
                                value <=> root.seed;
                                maximum: 100000;
                            }
                        }
                    }
                    ScrollView {
                        max-height: 300px;  
                        VerticalBox {
                            spacing: 5px;
                            // Model-specific parameters
                            if root.model_type == "GBM" || root.model_type == "JumpDiffusion": VerticalBox {
                                spacing: 5px;
                                Text { text: "GBM Parameters:"; font-weight: 600; }
                                GridBox {
                                    Row { 
                                        Text { text: "Drift (Î¼) daily:"; }
                                        LineEdit { 
                                            text: root.mu;
                                            edited(text) => { root.mu = text.to-float(); }
                                        } 
                                    }
                                    Row { 
                                        Text { text: "Volatility (Ïƒ) daily:"; }
                                        LineEdit { 
                                            text: root.sigma;
                                            edited(text) => { root.sigma = text.to-float(); }
                                        } 
                                    }
                                }
                            }
                    
                            // Jump Diffusion specific parameters
                            if root.model_type == "JumpDiffusion": VerticalBox {
                                spacing: 5px;
                                Text { text: "Jump Parameters:"; font-weight: 600; }
                                GridBox {
                                    Row { 
                                        Text { text: "Jump Intensity (Î»):"; }
                                        LineEdit { 
                                            text: root.lambda;
                                            edited(text) => { root.lambda = text.to-float(); }
                                        } 
                                    }
                                    Row { 
                                        Text { text: "Jump Mean (Î¼_j):"; }
                                        LineEdit { 
                                            text: root.mu_j;
                                            edited(text) => { root.mu_j = text.to-float(); }
                                        } 
                                    }
                                    Row { 
                                        Text { text: "Jump Std (Ïƒ_j):"; }
                                        LineEdit { 
                                            text: root.sigma_j;
                                            edited(text) => { root.sigma_j = text.to-float(); }
                                        } 
                                    }
                                }
                            }
                    
                            // Mean Reversion parameters
                            if root.model_type == "MeanReversion": VerticalBox {
                                spacing: 5px;
                                Text { text: "Mean Reversion Parameters:"; font-weight: 600; }
                                GridBox {
                                    Row { 
                                        Text { text: "Speed (Î¸):"; }
                                        LineEdit { 
                                            text: root.theta;
                                            edited(text) => { root.theta = text.to-float(); }
                                        } 
                                    }
                                    Row { 
                                        Text { text: "Long-term Mean (Î¼):"; }
                                        LineEdit { 
                                            text: root.mu_long_term;
                                            edited(text) => { root.mu_long_term = text.to-float(); }
                                        } 
                                    }
                                    Row { 
                                        Text { text: "Volatility (Ïƒ):"; }
                                        LineEdit { 
                                            text: root.sigma;
                                            edited(text) => { root.sigma = text.to-float(); }
                                        } 
                                    }
                                }
                            }
                            
                            // GARCH parameters
                            if root.model_type == "GARCH": VerticalBox {
                                spacing: 5px;
                                Text { text: "GARCH(1,1) Parameters:"; font-weight: 600; }
                                GridBox {
                                    Row { 
                                        Text { text: "Omega (Ï‰):"; }
                                        LineEdit { 
                                            text: root.omega;
                                            edited(text) => { root.omega = text.to-float(); }
                                        } 
                                    }
                                    Row { 
                                        Text { text: "Alpha (Î±):"; }
                                        LineEdit { 
                                            text: root.alpha;
                                            edited(text) => { root.alpha = text.to-float(); }
                                        } 
                                    }
                                    Row { 
                                        Text { text: "Beta (Î²):"; }
                                        LineEdit { 
                                            text: root.beta;
                                            edited(text) => { root.beta = text.to-float(); }
                                        } 
                                    }
                                }
                                Text { 
                                    text: "Constraint: Î± + Î² < 1"; 
                                    font-size: 10px;
                                    color: #888;
                                }
                            }
                        }
                    }
                    CheckBox {
                        text: "Use Antithetic Variates";
                        checked <=> root.use_antithetic;
                    }
                    Button {
                        text: "RUN SIMULATION";
                        primary: true;
                        clicked => { run_simulation_pressed({
                            initial_price: root.initial_price,
                            horizon: root.horizon,
                            num_paths: root.num_paths,
                            mu: root.mu,
                            sigma: root.sigma,
                            seed: root.seed,
                            use_antithetic: root.use_antithetic,
                            dt: 1,
                            model_type: root.model_type,
                            // Mean Reversion params
                            theta: root.theta,
                            mu_long_term: root.mu_long_term,
                            // Jump Diffusion params
                            lambda: root.lambda,
                            mu_j: root.mu_j,
                            sigma_j: root.sigma_j,
                            // GARCH params
                            omega: root.omega,
                            alpha: root.alpha,
                            beta: root.beta,
                        });
                    }
                }
            }
        }
     }

        VerticalBox { // Middle Panel
            min-width: 400px;
            horizontal-stretch: 1;
            vertical-stretch: 1;
            GroupBox {
                title: "Visual Output";
                vertical-stretch: 1;
                TabWidget { 
                    vertical-stretch: 1;
                    Tab {
                        title: "Price Paths";
                        VerticalBox {
                            spacing: 10px;
                            padding: 5px;
                            Text { text: "Simulated Price Paths (50 Sample Scenarios)"; horizontal-alignment: center; }
                            Image { 
                                source <=> root.price_chart;
                                image-fit: fill;
                                vertical-stretch: 1;
                            }
                        }
                    }
                    Tab {
                        title: "Histogram";
                        VerticalBox {
                            spacing: 10px;
                            padding: 5px;
                            Text { text: "Histogram of Terminal Prices"; horizontal-alignment: center; }
                            Image { 
                                source <=> root.hist_chart;
                                image-fit: fill;
                                vertical-stretch: 1;
                            }
                        }
                    }
                }
            }
        }

        VerticalBox { // Right Panel
            preferred-width: 250px;
            min-width: 240px;
            vertical-stretch: 1;
            GroupBox {
                title: "Summary & Export";
                vertical-stretch: 1; 
                VerticalBox {
                    Text { text: "Statistical Summary"; }
                    GridBox {
                        Row { 
                            Text { text: "Mean:";} 
                            Text { text: "\{stats.mean}"; } 
                        }
                        Row { 
                            Text { text: "Std Dev:";} 
                            Text { text: "\{stats.std_dev}  "; } 
                        }
                        Row { 
                            Text { text: "Median (P50):";} 
                            Text { text: "\{stats.median} "; } 
                        }
                        Row { 
                            Text { text: "P5:";} 
                            Text { text: "\{stats.p5}  "; } 
                        }
                        Row { 
                            Text { text: "P25:";} 
                            Text { text: "\{stats.p25}  "; } 
                        }
                        Row { 
                            Text { text: "P75:";} 
                            Text { text: "\{stats.p75}  "; } 
                        }
                        Row { 
                            Text { text: "P95:";} 
                            Text { text: "\{stats.p95}  "; } 
                        }
                        Row { 
                            Text { text: "VaR 95%:";} 
                            Text { text: "\{stats.var95} "; } 
                        }
                    }
                    
                    Text { text: "Performance: ";}
                    Text { text: "Execution time: " + root.exec_time;}
                    Text { text: "Export Options";}
                    Button { 
                        text: "Save Summary (CSV)";
                        clicked => { export_summary_pressed(); } 
                    }
                    Button { 
                        text: "Save Charts (PNG)";
                        clicked => { export_charts_pressed(); } 
                    }
                }
            }
        }
    }
}